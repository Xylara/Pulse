<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" src="/others/pulse.png" />
  <title>Pulse - Account</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<style>
  body::-webkit-scrollbar {
    width: 4px;
  }

  body::-webkit-scrollbar-track {
    background: #1e1e1e;
  }

  body::-webkit-scrollbar-thumb {
    background: #7289da;
  }

  body::-webkit-scrollbar-thumb:hover {
    background: #6372e9;
  }
</style>

<body class="bg-gradient-to-r from-gray-900 to-gray-800 font-sans text-white antialiased min-h-screen">
  <main class="p-8 min-h-screen">
    <div class="max-w-3xl mx-auto bg-gray-800 p-8 rounded-lg shadow-xl">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-blue-600">Account Settings</h1>
        <a href="/dashboard"
          class="inline-flex items-center px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg shadow-md transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z"
              clip-rule="evenodd" />
          </svg>
          Back to Dashboard
        </a>
      </div>

      <% if (locals.error) { %>
      <div class="bg-red-500 text-white text-center py-3 rounded-lg mb-6 font-semibold">
        <%= error %>
      </div>
      <% } else if (locals.success) { %>
      <div class="bg-green-500 text-white text-center py-3 rounded-lg mb-6 font-semibold">
        <%= success %>
      </div>
      <% } %>

      <section class="mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-300">Profile Picture</h2>
        <div class="flex items-center space-x-4 mb-4">
          <img id="profilePicturePreview" src="<%= user.profilepicture %>" alt="Profile Picture"
            class="w-24 h-24 rounded-full object-cover border-2 border-blue-500" />
          <div>
            <p class="text-gray-400">Current Profile Picture</p>
            <p class="text-sm text-gray-500">Max size: 96x96 pixels</p>
          </div>
        </div>
        <form id="profilePictureForm" class="space-y-4">
          <div>
            <label for="profilePictureInput" class="block text-gray-400 text-sm font-bold mb-2">Upload New Profile
              Picture</label>
            <input type="file" id="profilePictureInput" name="profilePicture" accept="image/*"
              class="w-full p-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-gray-600 outline-none transition text-white" />
          </div>
          <button type="submit"
            class="w-full py-3 bg-blue-600 rounded-lg hover:bg-blue-500 shadow-md hover:shadow-lg transition duration-300">
            Update Profile Picture
          </button>
        </form>
        <canvas id="profilePictureCanvas" class="hidden"></canvas>
      </section>

      <section class="mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-300">Update Username</h2>
        <form action="/account/username" method="POST" class="space-y-4">
          <div>
            <label for="username" class="block text-gray-400 text-sm font-bold mb-2">New Username</label>
            <input type="text" id="username" name="username" value="<%= user.username %>" required
              class="w-full p-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-gray-600 outline-none transition text-white" />
          </div>
          <button type="submit"
            class="w-full py-3 bg-blue-600 rounded-lg hover:bg-blue-500 shadow-md hover:shadow-lg transition duration-300">
            Update Username
          </button>
        </form>
      </section>

      <section class="mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-300">Update Email</h2>
        <form action="/account/email" method="POST" class="space-y-4">
          <div>
            <label for="email" class="block text-gray-400 text-sm font-bold mb-2">New Email</label>
            <input type="email" id="email" name="email" value="<%= user.email %>" required
              class="w-full p-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-gray-600 outline-none transition text-white" />
          </div>
          <button type="submit"
            class="w-full py-3 bg-blue-600 rounded-lg hover:bg-blue-500 shadow-md hover:shadow-lg transition duration-300">
            Update Email
          </button>
        </form>
      </section>

      <section>
        <h2 class="text-xl font-semibold mb-4 text-gray-300">Change Password</h2>
        <button id="togglePasswordForm"
          class="w-full py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-300">
          Change Password
        </button>

        <form action="/account/password" method="POST" id="passwordForm" class="space-y-4 mt-4 hidden">
          <div>
            <label for="currentPassword" class="block text-gray-400 text-sm font-bold mb-2">Current Password</label>
            <input type="password" id="currentPassword" name="currentPassword" placeholder="Current Password" required
              class="w-full p-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-gray-600 outline-none transition text-white" />
          </div>
          <div>
            <label for="newPassword" class="block text-gray-400 text-sm font-bold mb-2">New Password</label>
            <input type="password" id="newPassword" name="newPassword" placeholder="New Password" required
              class="w-full p-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-gray-600 outline-none transition text-white" />
          </div>
          <div>
            <label for="repeatNewPassword" class="block text-gray-400 text-sm font-bold mb-2">Repeat New Password</label>
            <input type="password" id="repeatNewPassword" name="repeatNewPassword" placeholder="Repeat New Password"
              required
              class="w-full p-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-gray-600 outline-none transition text-white" />
          </div>
          <button type="submit"
            class="w-full py-3 bg-blue-600 rounded-lg hover:bg-blue-500 shadow-md hover:shadow-lg transition duration-300">
            Save New Password
          </button>
        </form>
      </section>
    </div>
  </main>

  <script>
    document.getElementById('togglePasswordForm').addEventListener('click', function () {
      const passwordForm = document.getElementById('passwordForm');
      passwordForm.classList.toggle('hidden');
    });

    document.addEventListener('DOMContentLoaded', () => {
      const profilePictureInput = document.getElementById('profilePictureInput');
      const profilePicturePreview = document.getElementById('profilePicturePreview');
      const profilePictureForm = document.getElementById('profilePictureForm');
      const profilePictureCanvas = document.getElementById('profilePictureCanvas');
      const ctx = profilePictureCanvas.getContext('2d');

      const CDN_BASE_URL = '<%= process.env.CDN_BASE_URL %>';
      const CDN_UPLOAD_PATH = '<%= process.env.CDN_UPLOAD_PATH %>';
      const AUTH_TOKEN = '<%= process.env.CDN_AUTH_TOKEN %>';

      let currentProfileImageFile = null;

      profilePictureInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          currentProfileImageFile = file;
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              profilePictureCanvas.width = 96;
              profilePictureCanvas.height = 96;
              ctx.imageSmoothingQuality = 'high';
              ctx.drawImage(img, 0, 0, 96, 96);

              profilePicturePreview.src = profilePictureCanvas.toDataURL('image/png');
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          currentProfileImageFile = null;
          profilePicturePreview.src = '<%= user.profilepicture %>';
        }
      });

      profilePictureForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentProfileImageFile) {
          alert('Please select an image to upload.');
          return;
        }

        const resizedImageBlob = await new Promise(resolve => {
          profilePictureCanvas.toBlob(resolve, 'image/png');
        });

        const formData = new FormData();
        const filename = `profile-${Date.now()}.png`;
        formData.append('file', resizedImageBlob, filename);
        formData.append('folder', 'profile');
        formData.append('filename', filename);

        try {
          const response = await fetch(CDN_BASE_URL + CDN_UPLOAD_PATH, {
            method: 'POST',
            headers: {
              'Authorization': AUTH_TOKEN,
            },
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`CDN Upload Failed: ${response.status} ${response.statusText} - ${errorText}`);
          }

          const data = await response.json();
          if (data && data.fileUrl) {
            const newProfilePictureUrl = CDN_BASE_URL + data.fileUrl;
            const updateResponse = await fetch('/account/profilepicture', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ profilepicture: newProfilePictureUrl }),
            });

            if (!updateResponse.ok) {
              const errorData = await updateResponse.json();
              throw new Error(errorData.error || 'Failed to update profile picture on backend.');
            }

            window.location.href = '/account?success=profilePictureUpdated';
          } else {
            throw new Error('CDN Upload Response did not contain a fileUrl.');
          }
        } catch (error) {
          console.error('Error uploading profile picture:', error);
          alert(`Failed to update profile picture: ${error.message}`);
        }
      });
    });
  </script>
</body>

</html>